define("tiny_c4l/ui",["exports","./common","./modal","core/modal_factory","core/str","./options","core/modal_events","./variantslib","./helper","./preferencelib","core/ajax"],(function(_exports,_common,_modal,_modal_factory,_str,_options,_modal_events,_variantslib,_helper,_preferencelib,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny C4L UI.
   *
   * @module      tiny_c4l/ui
   * @copyright   2022 Marc Catal√† <reskit@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);let userStudent=!1,previewC4L=!0,components=[],categories=[],flavors=[],variants=[],langStrings={},currentFlavor="",currentFlavorId=0,currentCategoryId=1,lastFlavor=[];_exports.handleAction=async editor=>{userStudent=(0,_options.isStudent)(editor);let data=await getC4LData();components=data.components,categories=data.categories,flavors=data.flavors,variants=data.variants,(0,_variantslib.setComponents)(components),(0,_variantslib.setVariants)(variants),(0,_variantslib.setFlavors)(flavors),previewC4L=(0,_options.showPreview)(editor),langStrings=await getAllStrings(),currentCategoryId=await(0,_preferencelib.loadPreferences)(_preferencelib.Preferences.category),lastFlavor=await(0,_preferencelib.loadPreferences)(_preferencelib.Preferences.category_flavors),null===lastFlavor&&(lastFlavor=[]);let componentVariants=await(0,_preferencelib.loadPreferences)(_preferencelib.Preferences.component_variants);null===componentVariants&&(componentVariants={}),(0,_variantslib.loadVariantPreferences)(componentVariants),displayDialogue(editor)};const displayDialogue=async editor=>{const data=Object.assign({},{}),templateContext=await getTemplateContext(editor,data),modal=await _modal_factory.default.create({type:_modal.default.TYPE,templateContext:templateContext,large:!0});previewC4L||editor.targetElm.closest("body").classList.add("c4l-modal-no-preview"),modal.show(),modal.getRoot().on(_modal_events.default.hidden,(()=>{handleModalHidden(editor)}));const filters=modal.getRoot()[0].querySelectorAll(".c4l-button-filter");filters.forEach((node=>{node.addEventListener("click",(event=>{handleButtonFilterClick(event,modal)}))}));modal.getRoot()[0].querySelector(".c4l-select-filter").addEventListener("change",(event=>{handleSelectFilterChange(event,modal)}));modal.getRoot()[0].querySelectorAll(".c4l-button-flavor").forEach((node=>{node.addEventListener("click",(event=>{handleButtonFlavorClick(event,modal)}))}));modal.getRoot()[0].querySelectorAll(".c4lt-dialog-button").forEach((node=>{node.addEventListener("click",(event=>{handleButtonClick(event,editor,modal)})),previewC4L&&(node.addEventListener("mouseenter",(event=>{handleButtonMouseEvent(event,modal,!0)})),node.addEventListener("mouseleave",(event=>{handleButtonMouseEvent(event,modal,!1)})))}));if(modal.getRoot()[0].querySelectorAll(".c4l-button-variant").forEach((node=>{node.addEventListener("click",(event=>{handleVariantClick(event,modal)}))})),filters.length>0){let savedCategory=currentCategoryId;filters[0].click(),0!=savedCategory&&filters.forEach((filter=>{filter.dataset.filter==savedCategory&&filter.click()}))}clickFlavor(modal,lastFlavor[currentCategoryId]?lastFlavor[currentCategoryId]:0)},handleButtonFilterClick=(event,modal)=>{const button=event.target.closest("button");currentCategoryId=button.dataset.filter;modal.getRoot()[0].querySelectorAll(".c4l-buttons-filters button").forEach((node=>node.classList.remove("c4l-button-filter-enabled"))),button.classList.add("c4l-button-filter-enabled"),showFlavors(modal,currentCategoryId),showCategoryButtons(modal,currentCategoryId),clickFlavor(modal,lastFlavor[currentCategoryId]?lastFlavor[currentCategoryId]:0)},handleSelectFilterChange=(event,modal)=>{currentCategoryId=event.target.value,showFlavors(modal,currentCategoryId),showCategoryButtons(modal,currentCategoryId),clickFlavor(modal,lastFlavor[currentCategoryId]?lastFlavor[currentCategoryId]:0)},clickFlavor=function(modal){let flavor=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0==flavor){let availableFlavors=modal.getRoot()[0].querySelectorAll(".c4l-button-flavor:not(.c4l-hidden)");if(availableFlavors.length>0)availableFlavors[0].click();else{modal.getRoot()[0].querySelectorAll(".c4l-buttons-preview button").forEach((componentButton=>{null!=componentButton.dataset.flavor&&(componentButton.classList.remove(componentButton.dataset.flavor),componentButton.removeAttribute("data-flavor"))}))}return}let flavorButtons=modal.getRoot()[0].querySelectorAll(".c4l-buttons-flavors button");flavorButtons.forEach((node=>{node.dataset.id==flavor&&node.click()}))},showFlavors=(modal,categoryId)=>{modal.getRoot()[0].querySelectorAll(".c4l-button-flavor").forEach((node=>{node.classList.remove("c4l-button-flavor-enabled");let categories=node.dataset.categories.split(",");0==categories.length||categories.includes(categoryId)?node.classList.remove("c4l-hidden"):node.classList.add("c4l-hidden")}))},handleButtonFlavorClick=(event,modal)=>{const button=event.target.closest("button");currentFlavor=button.dataset.flavor,currentFlavorId=button.dataset.id,lastFlavor[currentCategoryId]=currentFlavorId;modal.getRoot()[0].querySelectorAll(".c4l-buttons-flavors button").forEach((node=>node.classList.remove("c4l-button-flavor-enabled"))),button.classList.add("c4l-button-flavor-enabled");modal.getRoot()[0].querySelectorAll(".c4l-buttons-preview button").forEach((componentButton=>{if(null!=componentButton.dataset.flavor&&componentButton.classList.remove(componentButton.dataset.flavor),componentButton.classList.add(currentFlavor),componentButton.dataset.flavor=currentFlavor,""!=componentButton.dataset.flavorlist&&!componentButton.dataset.flavorlist.split(",").includes(currentFlavor)||componentButton.dataset.category!=currentCategoryId)componentButton.classList.add("c4l-hidden");else if(componentButton.classList.remove("c4l-hidden"),""!=componentButton.dataset.flavorlist){let variants=(0,_variantslib.getVariantsClass)(components[componentButton.dataset.id].name,currentFlavor);componentButton.querySelectorAll(".c4l-button-variant").forEach((variant=>{-1!=variants.indexOf("c4l-"+variant.dataset.variant+"-variant")?updateVariantButtonState(variant,!0):updateVariantButtonState(variant,!1)}))}}))},handleModalHidden=editor=>{editor.targetElm.closest("body").classList.remove("c4l-modal-no-preview"),(0,_preferencelib.savePreferences)([{type:_preferencelib.Preferences.category,value:currentCategoryId},{type:_preferencelib.Preferences.category_flavors,value:JSON.stringify(lastFlavor)},{type:_preferencelib.Preferences.component_variants,value:JSON.stringify((0,_variantslib.getVariantPreferences)())}])},updateComponentCode=function(componentCode,selectedButton,placeholder){let flavor=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";componentCode=componentCode.replace("{{PLACEHOLDER}}",placeholder);const variants=(0,_variantslib.getVariantsClass)(components[selectedButton].name,flavor);return componentCode=variants.length>0?(componentCode=componentCode.replace("{{VARIANTS}}",variants.join(" "))).replace("{{VARIANTSHTML}}",(0,_variantslib.getVariantsHtml)(components[selectedButton].name)):(componentCode=componentCode.replace("{{VARIANTS}}","")).replace("{{VARIANTSHTML}}",""),componentCode=(componentCode=(componentCode=currentFlavor?componentCode.replace("{{FLAVOR}}",currentFlavor):componentCode.replace("{{FLAVOR}}","")).replace("{{COMPONENT}}",components[selectedButton].name)).replace("{{CATEGORY}}",categories[currentCategoryId].name),componentCode=applyRandomID(componentCode),componentCode=applyLangStrings(componentCode)},handleButtonClick=async(event,editor,modal)=>{const selectedButton=event.target.closest("button").dataset.id;if(components[selectedButton]){const sel=editor.selection.getContent();let componentCode=components[selectedButton].code;const placeholder=sel.length>0?sel:components[selectedButton].text;let flavor=components[selectedButton].flavors.length>0?currentFlavor:"";const randomId=generateRandomID(),newNode=document.createElement("span");newNode.dataset.id=randomId,newNode.innerHTML=placeholder,componentCode=updateComponentCode(componentCode,selectedButton,newNode.outerHTML,flavor),editor.selection.setContent(componentCode);const nodeSel=editor.dom.select('span[data-id="'+randomId+'"]');null!=nodeSel&&nodeSel[0]&&editor.selection.select(nodeSel[0]),modal.destroy(),editor.focus()}},handleButtonMouseEvent=(event,modal,show)=>{const selectedButton=event.target.closest("button").dataset.id,node=modal.getRoot()[0].querySelector('div[data-id="code-preview-'+selectedButton+'"]'),previewDefault=modal.getRoot()[0].querySelector('div[data-id="code-preview-default"]');let flavor=components[selectedButton].flavors.length>0?currentFlavor:"";node.innerHTML=updateComponentCode(components[selectedButton].code,selectedButton,components[selectedButton].text,flavor),node&&(show?(previewDefault.classList.toggle("c4l-hidden"),node.classList.toggle("c4l-hidden")):(node.classList.toggle("c4l-hidden"),previewDefault.classList.toggle("c4l-hidden")))},handleVariantClick=(event,modal)=>{event.stopPropagation();const variant=event.target.closest("span"),button=event.target.closest("button"),flavor=components[button.dataset.id].flavors.length>0?currentFlavor:"";updateVariantComponentState(variant,button,modal,!1,!0);modal.getRoot()[0].querySelector('div[data-id="code-preview-'+button.dataset.id+'"]').innerHTML=updateComponentCode(components[button.dataset.id].code,button.dataset.id,components[button.dataset.id].text,flavor)},getTemplateContext=async(editor,data)=>Object.assign({},{elementid:editor.id,buttons:await getButtons(editor),filters:await getFilters(),flavors:flavors,preview:previewC4L},data),getFilters=async()=>{const filters=[];return categories.forEach((category=>{filters.push({id:category.id,name:category.displayname,type:category.id,filterClass:1===category.order?"c4l-button-filter-enabled":"",displayorder:category.displayorder})})),filters.sort(((a,b)=>a.displayorder-b.displayorder)),filters},getComponentVariants=component=>{const componentVariants=[];return component.variants.forEach((variant=>{let variantitem=(0,_helper.findByName)(variants,variant);if(void 0!==variantitem){let state=(0,_variantslib.variantExists)(component.name,variantitem.name)?"on":"off";componentVariants.push({id:variantitem.id,name:variantitem.name,state:state,imageClass:variantitem.name+"-variant-"+state,title:langStrings.get(variantitem.name),content:variantitem.content})}})),componentVariants},getButtons=async editor=>{const buttons=[];editor.selection.getContent();return Object.values(components).forEach((component=>{buttons.push({id:component.id,name:component.displayname,type:component.compcat,imageClass:"c4l-"+component.name+"-icon",htmlcode:component.code,variants:getComponentVariants(component),flavorlist:component.flavors.join(","),category:component.compcat})})),buttons.sort(((a,b)=>a.displayorder-b.displayorder)),buttons},getC4LData=async()=>{const data=await(0,_ajax.call)([{methodname:"tiny_c4l_get_c4l_data",args:{isstudent:userStudent,contextid:1}}])[0],indexedComponents=[];data.components.forEach((component=>{indexedComponents[component.id]=component}));const indexedVariants=[];data.variants.forEach((variant=>{indexedVariants[variant.id]=variant}));const indexedCategories=[];return data.categories.forEach((category=>{indexedCategories[category.id]=category})),{components:indexedComponents,variants:indexedVariants,categories:indexedCategories,flavors:data.flavors}},updateVariantComponentState=(variant,button,modal,show,updateHtml)=>{const selectedVariant="c4l-"+variant.dataset.variant+"-variant",selectedButton=button.dataset.id,componentClass=button.dataset.classcomponent,previewComponent=modal.getRoot()[0].querySelector('div[data-id="code-preview-'+selectedButton+'"] .'+componentClass),variantPreview=modal.getRoot()[0].querySelector('span[data-id="variantHTML-'+selectedButton+'"]');let variantsHtml="",hasflavors=components[selectedButton].flavors.length>0;previewComponent?updateHtml?("on"==variant.dataset.state?((0,_variantslib.removeVariant)(components[selectedButton].name,variant.dataset.variant,hasflavors?currentFlavor:""),updateVariantButtonState(variant,!1),previewComponent.classList.remove(selectedVariant)):((0,_variantslib.addVariant)(components[selectedButton].name,variant.dataset.variant,hasflavors?currentFlavor:""),updateVariantButtonState(variant,!0),previewComponent.classList.add(selectedVariant)),variantPreview&&(variantPreview.innerHTML=(0,_variantslib.getVariantsHtml)(components[selectedButton].name))):(variantsHtml=(0,_variantslib.getVariantsHtml)(components[selectedButton].name),show?(previewComponent.classList.add(selectedVariant),variantsHtml+=(0,_variantslib.getVariantHtml)(variant.dataset.variant)):previewComponent.classList.remove(selectedVariant),variantPreview&&(variantPreview.innerHTML=variantsHtml)):"on"==variant.dataset.state?((0,_variantslib.removeVariant)(components[selectedButton].name,variant.dataset.variant,hasflavors?currentFlavor:""),updateVariantButtonState(variant,!1)):((0,_variantslib.addVariant)(components[selectedButton].name,variant.dataset.variant,hasflavors?currentFlavor:""),updateVariantButtonState(variant,!0))},updateVariantButtonState=(variant,activate)=>{activate?(variant.dataset.state="on",variant.classList.remove(variant.dataset.variant+"-variant-off"),variant.classList.add(variant.dataset.variant+"-variant-on"),variant.classList.add("on")):(variant.dataset.state="off",variant.classList.remove(variant.dataset.variant+"-variant-on"),variant.classList.add(variant.dataset.variant+"-variant-off"),variant.classList.remove("on"))},showCategoryButtons=(modal,context)=>{const showNodes=modal.getRoot()[0].querySelectorAll('button[data-type="'+context+'"]'),hideNodes=modal.getRoot()[0].querySelectorAll('button[data-type]:not([data-type="'+context+'"])');showNodes.forEach((node=>node.classList.remove("c4l-hidden"))),hideNodes.forEach((node=>node.classList.add("c4l-hidden")))},applyLangStrings=text=>([...text.matchAll(/{{#([^}]*)}}/g)].forEach((strLang=>{text=text.replace("{{#"+strLang[1]+"}}",langStrings.get(strLang[1]))})),text),generateRandomID=()=>{const timestamp=(new Date).getTime();return"R"+Math.round(1e5*Math.random())+"-"+timestamp},applyRandomID=text=>{const compRegex=/{{@ID}}/g;return text.match(compRegex)&&(text=text.replace(compRegex,generateRandomID())),text},getAllStrings=async()=>{const keys=[],compRegex=/{{#([^}]*)}}/g;components.forEach((element=>{[...element.code.matchAll(compRegex)].forEach((strLang=>{-1===keys.indexOf(strLang[1])&&keys.push(strLang[1])}))}));const stringValues=await(0,_str.get_strings)(keys.map((key=>({key:key,component:_common.component}))));return new Map(keys.map(((key,index)=>[key,stringValues[index]])))}}));

//# sourceMappingURL=ui.min.js.map