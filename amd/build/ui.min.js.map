{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny C4L UI.\n *\n * @module      tiny_c4l/ui\n * @copyright   2022 Marc Catal√† <reskit@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport C4LModal from './modal';\nimport ModalFactory from 'core/modal_factory';\nimport {get_strings as getStrings} from 'core/str';\nimport {\n    isStudent,\n    showPreview\n} from './options';\nimport ModalEvents from 'core/modal_events';\nimport {\n    addVariant,\n    getVariantsClass,\n    getVariantHtml,\n    getVariantPreferences,\n    getVariantsHtml,\n    loadVariantPreferences,\n    removeVariant,\n    setFlavors,\n    setVariants,\n    variantExists,\n    setComponents\n} from './variantslib';\nimport {\n    findByName\n} from './helper';\nimport {\n    savePreferences,\n    loadPreferences,\n    Preferences\n} from './preferencelib';\nimport {call as fetchMany} from 'core/ajax';\n\nlet userStudent = false;\n\nlet previewC4L = true;\nlet components = [];\nlet categories = [];\nlet flavors = [];\nlet variants = [];\nlet langStrings = {};\nlet contextid = 1;\n\nlet currentFlavor = '';\nlet currentFlavorId = 0;\nlet currentCategoryId = 1;\nlet lastFlavor = [];\n\n/**\n * Handle action\n *\n * @param {TinyMCE} editor\n */\nexport const handleAction = async(editor) => {\n    userStudent = isStudent(editor);\n    let data = await getC4LData();\n    components = data.components;\n    categories = data.categories;\n    flavors = data.flavors;\n    variants = data.variants;\n    setComponents(components);\n    setVariants(variants);\n    setFlavors(flavors);\n    previewC4L = showPreview(editor);\n    langStrings = await getAllStrings();\n    currentCategoryId = await loadPreferences(Preferences.category);\n    lastFlavor = await loadPreferences(Preferences.category_flavors);\n    if (lastFlavor === null) {\n        lastFlavor = [];\n    }\n    let component_variants = await loadPreferences(Preferences.component_variants);\n    if (component_variants === null) {\n        component_variants = {};\n    }\n    loadVariantPreferences(component_variants);\n    displayDialogue(editor);\n};\n\n/**\n * Display modal\n *\n * @param  {TinyMCE} editor\n */\nconst displayDialogue = async(editor) => {\n    const data = Object.assign({}, {});\n    const templateContext = await getTemplateContext(editor, data);\n    // Show modal with buttons.\n    const modal = await ModalFactory.create({\n        type: C4LModal.TYPE,\n        templateContext: templateContext,\n        large: true,\n    });\n\n    // Set modal size when no preview.\n    if (!previewC4L) {\n        editor.targetElm.closest('body').classList.add('c4l-modal-no-preview');\n    }\n    modal.show();\n\n    // Event modal listener.\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        handleModalHidden(editor);\n    });\n\n    // Event filters listener.\n    const filters = modal.getRoot()[0].querySelectorAll('.c4l-button-filter');\n    filters.forEach(node => {\n        node.addEventListener('click', (event) => {\n            handleButtonFilterClick(event, modal);\n        });\n    });\n\n    const selectfilter = modal.getRoot()[0].querySelector('.c4l-select-filter');\n    selectfilter.addEventListener('change', (event) => {\n        handleSelectFilterChange(event, modal);\n    });\n\n    // Event flavor selector listener.\n    const flavorbuttons = modal.getRoot()[0].querySelectorAll('.c4l-button-flavor');\n    flavorbuttons.forEach(node => {\n        node.addEventListener('click', (event) => {\n            handleButtonFlavorClick(event, modal);\n        });\n    });\n\n    // Event buttons listeners.\n    const buttons = modal.getRoot()[0].querySelectorAll('.c4lt-dialog-button');\n    buttons.forEach(node => {\n        node.addEventListener('click', (event) => {\n            handleButtonClick(event, editor, modal);\n        });\n        if (previewC4L) {\n            node.addEventListener('mouseenter', (event) => {\n                handleButtonMouseEvent(event, modal, true);\n            });\n            node.addEventListener('mouseleave', (event) => {\n                handleButtonMouseEvent(event, modal, false);\n            });\n        }\n    });\n\n    // Event variants listeners.\n    const variants = modal.getRoot()[0].querySelectorAll('.c4l-button-variant');\n    variants.forEach(node => {\n        node.addEventListener('click', (event) => {\n            handleVariantClick(event, modal);\n        });\n    });\n\n    if (filters.length > 0) {\n        let savedCategory = currentCategoryId;\n        filters[0].click();\n        if (savedCategory != 0) {\n            filters.forEach((filter) => {\n                if (filter.dataset.filter == savedCategory) {\n                    filter.click();\n                }\n            });\n        }\n    }\n\n    clickFlavor(modal, lastFlavor[currentCategoryId] ? lastFlavor[currentCategoryId] : 0);\n};\n\n/**\n * Handle a click within filter button.\n *\n * @param {MouseEvent} event The change event\n * @param {obj} modal\n */\nconst handleButtonFilterClick = (event, modal) => {\n    const button = event.target.closest('button');\n    currentCategoryId = button.dataset.filter;\n\n    const buttons = modal.getRoot()[0].querySelectorAll('.c4l-buttons-filters button');\n    buttons.forEach(node => node.classList.remove('c4l-button-filter-enabled'));\n    button.classList.add('c4l-button-filter-enabled');\n\n    showFlavors(modal, currentCategoryId);\n\n    // Show/hide component buttons.\n    showCategoryButtons(modal, currentCategoryId);\n\n    clickFlavor(modal, lastFlavor[currentCategoryId] ? lastFlavor[currentCategoryId] : 0);\n};\n\nconst handleSelectFilterChange = (event, modal) => {\n    currentCategoryId = event.target.value;\n    showFlavors(modal, currentCategoryId);\n    showCategoryButtons(modal, currentCategoryId);\n    clickFlavor(modal, lastFlavor[currentCategoryId] ? lastFlavor[currentCategoryId] : 0);\n};\n\nconst clickFlavor = (modal, flavor = 0) => {\n    if (flavor == 0) {\n        let availableFlavors = modal.getRoot()[0].querySelectorAll('.c4l-button-flavor:not(.c4l-hidden)');\n        if (availableFlavors.length > 0) {\n            availableFlavors[0].click();\n        } else {\n            let componentButtons = modal.getRoot()[0].querySelectorAll('.c4l-buttons-preview button');\n            componentButtons.forEach(componentButton => {\n                if (componentButton.dataset.flavor != undefined) {\n                    componentButton.classList.remove(componentButton.dataset.flavor);\n                    componentButton.removeAttribute('data-flavor');\n                }\n            });\n        }\n        return;\n    }\n\n    let flavorButtons = modal.getRoot()[0].querySelectorAll('.c4l-buttons-flavors button');\n    flavorButtons.forEach(node => {\n        if (node.dataset.id == flavor) {\n            node.click();\n        }\n    });\n};\n\nconst showFlavors = (modal, categoryId) => {\n    const flavorButtons = modal.getRoot()[0].querySelectorAll('.c4l-button-flavor');\n    flavorButtons.forEach(node => {\n        node.classList.remove('c4l-button-flavor-enabled');\n        let categories = node.dataset.categories.split(',');\n        if (categories.length == 0 || categories.includes(categoryId)) {\n            node.classList.remove('c4l-hidden');\n        } else {\n            node.classList.add('c4l-hidden');\n        }\n    });\n};\n\nconst handleButtonFlavorClick = (event, modal) => {\n    const button = event.target.closest('button');\n    currentFlavor = button.dataset.flavor;\n    currentFlavorId = button.dataset.id;\n    lastFlavor[currentCategoryId] = currentFlavorId;\n\n    const buttons = modal.getRoot()[0].querySelectorAll('.c4l-buttons-flavors button');\n    buttons.forEach(node => node.classList.remove('c4l-button-flavor-enabled'));\n    button.classList.add('c4l-button-flavor-enabled');\n    const componentButtons = modal.getRoot()[0].querySelectorAll('.c4l-buttons-preview button');\n\n    componentButtons.forEach(componentButton => {\n        // Remove previous flavor.\n        if (componentButton.dataset.flavor != undefined) {\n            componentButton.classList.remove(componentButton.dataset.flavor);\n        }\n        componentButton.classList.add(currentFlavor);\n        componentButton.dataset.flavor = currentFlavor;\n        if (\n            (componentButton.dataset.flavorlist == '' || componentButton.dataset.flavorlist.split(',').includes(currentFlavor)) &&\n            componentButton.dataset.category == currentCategoryId\n        ) {\n            componentButton.classList.remove('c4l-hidden');\n            if (componentButton.dataset.flavorlist != '') {\n                let variants = getVariantsClass(components[componentButton.dataset.id].name, currentFlavor);\n                let availableVariants = componentButton.querySelectorAll('.c4l-button-variant');\n                availableVariants.forEach((variant) => {\n                    if (variants.indexOf(variant.dataset.variant) != -1) {\n                        updateVariantButtonState(variant, true);\n                    } else {\n                        updateVariantButtonState(variant, false);\n                    }\n                });\n            }\n        } else {\n            componentButton.classList.add('c4l-hidden');\n        }\n    });\n\n};\n\n/**\n * Handle when closing the Modal.\n *\n * @param {obj} editor\n */\nconst handleModalHidden = (editor) => {\n    editor.targetElm.closest('body').classList.remove('c4l-modal-no-preview');\n    savePreferences([\n        {type: Preferences.category, value: currentCategoryId},\n        {type: Preferences.category_flavors, value: JSON.stringify(lastFlavor)},\n        {type: Preferences.component_variants, value: JSON.stringify(getVariantPreferences())}\n    ]);\n};\n\nconst updateComponentCode = (componentCode, selectedButton, placeholder, flavor = '') => {\n    componentCode = componentCode.replace('{{PLACEHOLDER}}', placeholder);\n\n    // Return active variants for current component.\n    const variants = getVariantsClass(components[selectedButton].name, flavor);\n\n    // Apply variants to html component.\n    if (variants.length > 0) {\n        componentCode = componentCode.replace('{{VARIANTS}}', variants.join(' '));\n        componentCode = componentCode.replace('{{VARIANTSHTML}}', getVariantsHtml(components[selectedButton].name));\n    } else {\n        componentCode = componentCode.replace('{{VARIANTS}}', '');\n        componentCode = componentCode.replace('{{VARIANTSHTML}}', '');\n    }\n\n    if (currentFlavor) {\n        componentCode = componentCode.replace('{{FLAVOR}}', currentFlavor);\n    } else {\n        componentCode = componentCode.replace('{{FLAVOR}}', '');\n    }\n\n    componentCode = componentCode.replace('{{COMPONENT}}', components[selectedButton].name);\n    componentCode = componentCode.replace('{{CATEGORY}}', categories[currentCategoryId].name);\n\n    // Apply random IDs.\n    componentCode = applyRandomID(componentCode);\n\n    // Apply lang strings.\n    componentCode = applyLangStrings(componentCode);\n\n    return componentCode;\n};\n\n/**\n * Handle a click in a component button.\n *\n * @param {MouseEvent} event The click event\n * @param {obj} editor\n * @param {obj} modal\n */\nconst handleButtonClick = async (event, editor, modal) => {\n    const selectedButton = event.target.closest('button').dataset.id;\n\n    // Component button.\n    if (components[selectedButton]) {\n        const sel = editor.selection.getContent();\n        let componentCode = components[selectedButton].code;\n        const placeholder = (sel.length > 0 ? sel : components[selectedButton].text);\n\n        let flavor = components[selectedButton].flavors.length > 0 ? currentFlavor : '';\n\n        // Create a new node to replace the placeholder.\n        const randomId = generateRandomID();\n        const newNode = document.createElement('span');\n        newNode.dataset.id = randomId;\n        newNode.innerHTML = placeholder;\n        componentCode = updateComponentCode(componentCode, selectedButton, newNode.outerHTML, flavor);\n        // Sets new content.\n        editor.selection.setContent(componentCode);\n\n        // Select text.\n        const nodeSel = editor.dom.select('span[data-id=\"' + randomId + '\"]');\n        if (nodeSel?.[0]) {\n            editor.selection.select(nodeSel[0]);\n        }\n\n        modal.destroy();\n        editor.focus();\n    }\n};\n\n/**\n * Handle a mouse events mouseenter/mouseleave in a component button.\n *\n * @param {MouseEvent} event The click event\n * @param {obj} modal\n * @param {bool} show\n */\nconst handleButtonMouseEvent = (event, modal, show) => {\n    const selectedButton = event.target.closest('button').dataset.id;\n    const node = modal.getRoot()[0].querySelector('div[data-id=\"code-preview-' + selectedButton + '\"]');\n    const previewDefault = modal.getRoot()[0].querySelector('div[data-id=\"code-preview-default\"]');\n    let flavor = components[selectedButton].flavors.length > 0 ? currentFlavor : '';\n\n    node.innerHTML = updateComponentCode(components[selectedButton].code, selectedButton, components[selectedButton].text, flavor);\n\n    if (node) {\n        if (show) {\n            previewDefault.classList.toggle('c4l-hidden');\n            node.classList.toggle('c4l-hidden');\n        } else {\n            node.classList.toggle('c4l-hidden');\n            previewDefault.classList.toggle('c4l-hidden');\n        }\n    }\n};\n\n/**\n * Handle a mouse events mouseenter/mouseleave in a variant button.\n * Not used at the moment.\n *\n * @param {MouseEvent} event The mouseenter/mouseleave event\n * @param {obj} modal\n * @param {bool} show\n */\n// eslint-disable-next-line no-unused-vars\nconst handleVariantMouseEvent = (event, modal, show) => {\n    const variant = event.target.closest('span');\n    const variantEnabled = variant.dataset.state == 'on';\n    const button = event.target.closest('button');\n\n    if (!variantEnabled) {\n        updateVariantComponentState(variant, button, modal, show, false);\n    }\n};\n\n\n/**\n * Handle a mouse event within the variant buttons.\n *\n * @param {MouseEvent} event The mouseenter/mouseleave event\n * @param {obj} modal\n */\nconst handleVariantClick = (event, modal) => {\n    event.stopPropagation();\n    const variant = event.target.closest('span');\n    const button = event.target.closest('button');\n    const flavor = components[button.dataset.id].flavors.length > 0 ? currentFlavor : '';\n\n    updateVariantComponentState(variant, button, modal, false, true);\n\n    const node = modal.getRoot()[0].querySelector('div[data-id=\"code-preview-' + button.dataset.id + '\"]');\n    node.innerHTML = updateComponentCode(\n        components[button.dataset.id].code,\n        button.dataset.id,\n        components[button.dataset.id].text,\n        flavor\n    );\n};\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {Editor} editor\n * @param {object} data\n * @returns {object} data\n */\nconst getTemplateContext = async(editor, data) => {\n    return Object.assign({}, {\n        elementid: editor.id,\n        buttons: await getButtons(editor),\n        filters: await getFilters(),\n        flavors: flavors,\n        preview: previewC4L,\n    }, data);\n};\n\n/**\n * Get the C4L filters for the dialogue.\n *\n * @returns {object} data\n */\nconst getFilters = async() => {\n    const filters = [];\n    //const stringValues = await getStrings(Contexts.map((key) => ({key, component})));\n    // Iterate over contexts.\n    categories.forEach((category) => {\n        filters.push({\n            id: category.id,\n            name: category.displayname,\n            type: category.id,\n            filterClass: category.order === 1 ? 'c4l-button-filter-enabled' : '',\n            displayorder: category.displayorder,\n        });\n    });\n    filters.sort((a, b) => a.displayorder - b.displayorder);\n\n    return filters;\n};\n\nconst getComponentVariants = (component) => {\n    const componentVariants = [];\n    component.variants.forEach(variant => {\n        let variantitem = findByName(variants, variant);\n        if (variantitem !== undefined) {\n            let state = variantExists(component.name, variantitem.name) ? 'on' : 'off';\n            componentVariants.push({\n                id: variantitem.id,\n                name: variantitem.name,\n                state: state,\n                imageClass: variantitem.name + '-variant-' + state,\n                title: langStrings.get(variantitem.name),\n                content: variantitem.content,\n            });\n        }\n    });\n    return componentVariants;\n};\n\n/**\n * Get the C4L buttons for the dialogue.\n *\n * @param {Editor} editor\n * @returns {object} buttons\n */\nconst getButtons = async(editor) => {\n    const buttons = [];\n    // Not used at the moment.\n    // eslint-disable-next-line no-unused-vars\n    const sel = editor.selection.getContent();\n    Object.values(components).forEach(component => {\n        buttons.push({\n            id: component.id,\n            name: component.displayname,\n            type: component.compcat,\n            imageClass: 'c4l-' + component.name + '-icon',\n            htmlcode: component.code,\n            variants: getComponentVariants(component, variants),\n            flavorlist: component.flavors.join(','),\n            category: component.compcat,\n        });\n    });\n    buttons.sort((a, b) => a.displayorder - b.displayorder);\n\n    return buttons;\n};\n\nconst getC4LData = async() => {\n    const data = await fetchMany([{\n        methodname: 'tiny_c4l_get_c4l_data',\n        args: {\n            isstudent: userStudent,\n            contextid: contextid\n        },\n    }])[0];\n\n    // TODO error handling\n    const indexedComponents = [];\n    data.components.forEach(component => {\n        indexedComponents[component.id] = component;\n    });\n\n    const indexedVariants = [];\n    data.variants.forEach(variant => {\n        indexedVariants[variant.id] = variant;\n    });\n\n    const indexedCategories = [];\n    data.categories.forEach(category => {\n        indexedCategories[category.id] = category;\n    });\n\n    return {\n        components: indexedComponents,\n        variants: indexedVariants,\n        categories: indexedCategories,\n        flavors: data.flavors,\n    };\n};\n\n/**\n * Get variants for the dialogue.\n * Not used at the moment.\n *\n * @param  {string} component\n * @param  {object} elements\n * @return {object} Variants for a component\n */\n// eslint-disable-next-line no-unused-vars\nconst getVariantsState = (component, elements) => {\n    const variants = [];\n    let variantState = '';\n    let variantClass = '';\n\n    // Max 3 variants.\n    if (elements.length > 3) {\n        elements = elements.slice(0, 2);\n    }\n\n    elements.forEach((variant, index) => {\n        if (variantExists(component, variant)) {\n            variantState = 'on';\n            variantClass = 'on ';\n        } else {\n            variantState = 'off';\n            variantClass = '';\n        }\n        variantClass += variant + '-variant-' + variantState;\n        variants.push({\n            id: index,\n            name: variant,\n            state: variantState,\n            imageClass: variantClass,\n            title: langStrings.get(variant),\n        });\n    });\n\n    return variants;\n};\n\n/**\n * Update a variant component UI.\n *\n * @param {obj} variant\n * @param {obj} button\n * @param {obj} modal\n * @param {bool} show\n * @param {bool} updateHtml\n */\nconst updateVariantComponentState = (variant, button, modal, show, updateHtml) => {\n    const selectedVariant = 'c4l-' + variant.dataset.variant + '-variant';\n    const selectedButton = button.dataset.id;\n    const componentClass = button.dataset.classcomponent;\n    const previewComponent = modal.getRoot()[0]\n        .querySelector('div[data-id=\"code-preview-' + selectedButton + '\"] .' + componentClass);\n    const variantPreview = modal.getRoot()[0]\n        .querySelector('span[data-id=\"variantHTML-' + selectedButton + '\"]');\n    let variantsHtml = '';\n    let hasflavors = components[selectedButton].flavors.length > 0;\n\n    if (previewComponent) {\n        if (updateHtml) {\n            if (variant.dataset.state == 'on') {\n                removeVariant(components[selectedButton].name, variant.dataset.variant, hasflavors ? currentFlavor : '');\n                updateVariantButtonState(variant, false);\n                previewComponent.classList.remove(selectedVariant);\n            } else {\n                addVariant(components[selectedButton].name, variant.dataset.variant, hasflavors ? currentFlavor : '');\n                updateVariantButtonState(variant, true);\n                previewComponent.classList.add(selectedVariant);\n            }\n\n            // Update variant preview HTML.\n            if (variantPreview) {\n                variantPreview.innerHTML = getVariantsHtml(components[selectedButton].name);\n            }\n        } else {\n            variantsHtml = getVariantsHtml(components[selectedButton].name);\n            if (show) {\n                previewComponent.classList.add(selectedVariant);\n                variantsHtml += getVariantHtml(variant.dataset.variant);\n            } else {\n                previewComponent.classList.remove(selectedVariant);\n            }\n\n            // Update variant preview HTML.\n            if (variantPreview) {\n                variantPreview.innerHTML = variantsHtml;\n            }\n        }\n    } else {\n        // Update variants preferences.\n        if (variant.dataset.state == 'on') {\n            removeVariant(components[selectedButton].name, variant.dataset.variant, hasflavors ? currentFlavor : '');\n            updateVariantButtonState(variant, false);\n        } else {\n            addVariant(components[selectedButton].name, variant.dataset.variant, hasflavors ? currentFlavor : '');\n            updateVariantButtonState(variant, true);\n        }\n    }\n};\n\n/**\n * Update a variant button UI.\n *\n * @param {obj} variant\n * @param {bool} activate\n */\nconst updateVariantButtonState = (variant, activate) => {\n    if (activate) {\n        variant.dataset.state = 'on';\n        variant.classList.remove(variant.dataset.variant + '-variant-off');\n        variant.classList.add(variant.dataset.variant + '-variant-on');\n        variant.classList.add('on');\n    } else {\n        variant.dataset.state = 'off';\n        variant.classList.remove(variant.dataset.variant + '-variant-on');\n        variant.classList.add(variant.dataset.variant + '-variant-off');\n        variant.classList.remove('on');\n    }\n};\n\n/**\n * Show/hide buttons depend on selected context.\n *\n * @param  {object} modal\n * @param  {String} context\n */\nconst showCategoryButtons = (modal, context) => {\n    const showNodes = modal.getRoot()[0].querySelectorAll('button[data-type=\"' + context + '\"]');\n    const hideNodes = modal.getRoot()[0].querySelectorAll('button[data-type]:not([data-type=\"' + context + '\"])');\n\n    showNodes.forEach(node => node.classList.remove('c4l-hidden'));\n    hideNodes.forEach(node => node.classList.add('c4l-hidden'));\n};\n\n/**\n * Replace all localized strings.\n *\n * @param  {String} text\n * @return {String} String with lang tags replaced with a localized string.\n */\nconst applyLangStrings = (text) => {\n    const compRegex = /{{#([^}]*)}}/g;\n\n    [...text.matchAll(compRegex)].forEach(strLang => {\n        text = text.replace('{{#' + strLang[1] + '}}', langStrings.get(strLang[1]));\n    });\n\n    return text;\n};\n\n/**\n * Generates a random string.\n * @return {string} A random string\n */\nconst generateRandomID = () => {\n    const timestamp = new Date().getTime();\n    return 'R' + Math.round(Math.random() * 100000) + '-' + timestamp;\n};\n\n/**\n * Replace all ID tags with a random string.\n * @param  {String} text\n * @return {String} String with all ID tags replaced with a random string.\n */\nconst applyRandomID = (text) => {\n    const compRegex = /{{@ID}}/g;\n\n    if (text.match(compRegex)) {\n        text = text.replace(compRegex, generateRandomID());\n    }\n\n    return text;\n};\n\n/**\n * Get language strings.\n *\n * @return {object} Language strings\n */\nconst getAllStrings = async() => {\n    const keys = [];\n    const compRegex = /{{#([^}]*)}}/g;\n\n    components.forEach(element => {\n        // Get lang strings from components.\n        [...element.code.matchAll(compRegex)].forEach(strLang => {\n            if (keys.indexOf(strLang[1]) === -1) {\n                keys.push(strLang[1]);\n            }\n        });\n    });\n\n    const stringValues = await getStrings(keys.map((key) => ({key, component})));\n    return new Map(keys.map((key, index) => ([key, stringValues[index]])));\n};\n"],"names":["userStudent","previewC4L","components","categories","flavors","variants","langStrings","currentFlavor","currentFlavorId","currentCategoryId","lastFlavor","async","editor","data","getC4LData","getAllStrings","Preferences","category","category_flavors","component_variants","displayDialogue","Object","assign","templateContext","getTemplateContext","modal","ModalFactory","create","type","C4LModal","TYPE","large","targetElm","closest","classList","add","show","getRoot","on","ModalEvents","hidden","handleModalHidden","filters","querySelectorAll","forEach","node","addEventListener","event","handleButtonFilterClick","querySelector","handleSelectFilterChange","handleButtonFlavorClick","handleButtonClick","handleButtonMouseEvent","handleVariantClick","length","savedCategory","click","filter","dataset","clickFlavor","button","target","remove","showFlavors","showCategoryButtons","value","flavor","availableFlavors","componentButton","undefined","removeAttribute","flavorButtons","id","categoryId","split","includes","flavorlist","name","variant","indexOf","updateVariantButtonState","JSON","stringify","updateComponentCode","componentCode","selectedButton","placeholder","replace","join","applyRandomID","applyLangStrings","sel","selection","getContent","code","text","randomId","generateRandomID","newNode","document","createElement","innerHTML","outerHTML","setContent","nodeSel","dom","select","destroy","focus","previewDefault","toggle","stopPropagation","updateVariantComponentState","elementid","buttons","getButtons","getFilters","preview","push","displayname","filterClass","order","displayorder","sort","a","b","getComponentVariants","component","componentVariants","variantitem","state","imageClass","title","get","content","values","compcat","htmlcode","methodname","args","isstudent","contextid","indexedComponents","indexedVariants","indexedCategories","updateHtml","selectedVariant","componentClass","classcomponent","previewComponent","variantPreview","variantsHtml","hasflavors","activate","context","showNodes","hideNodes","matchAll","strLang","timestamp","Date","getTime","Math","round","random","compRegex","match","keys","element","stringValues","map","key","Map","index"],"mappings":"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"}